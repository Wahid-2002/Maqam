<!DOCTYPE html>
<html>
<head>
    <title>Maqam Identifier</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .section-title { font-weight: bold; margin-bottom: 10px; color: #444; }
        button { padding: 10px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 4px; margin: 5px; }
        button:hover { background: #45a049; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        .file-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .file-item { padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        .file-name { font-weight: bold; margin-bottom: 10px; }
        .predict-btn { background: #2196F3; }
        .predict-btn:hover { background: #0b7dda; }
        .result { margin-top: 10px; padding: 10px; background-color: #e9f7ef; border-radius: 4px; }
        .error { color: red; background-color: #ffebee; }
        .training-status { margin-top: 10px; padding: 10px; background-color: #e3f2fd; border-radius: 4px; }
        .progress-bar { height: 20px; background-color: #e0e0e0; border-radius: 10px; margin-top: 10px; }
        .progress-fill { height: 100%; background-color: #4CAF50; border-radius: 10px; transition: width 0.3s; }
        .predictions-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .predictions-table th, .predictions-table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .predictions-table th { background-color: #f2f2f2; }
        .confidence-bar { height: 10px; background-color: #e0e0e0; border-radius: 5px; margin-top: 5px; }
        .confidence-fill { height: 100%; background-color: #4CAF50; border-radius: 5px; }
        .description { background-color: #f0f7ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .description h3 { margin-top: 0; color: #2c3e50; }
        .description ol { padding-left: 20px; }
        .description li { margin-bottom: 8px; }
        #output { margin-top: 20px; padding: 15px; background: #f8f8f8; border: 1px solid #ddd; white-space: pre-wrap; border-radius: 4px; }
        .status-info { display: flex; justify-content: space-between; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Maqam Identifier</h1>
        
        <div class="description">
            <h3>How This Works</h3>
            <ol>
                <li><strong>Training Stage:</strong> The program first trains a machine learning model using the maqam samples from your dataset (hijaz, rast, bayati, etc.). This model learns the unique characteristics of each maqam.</li>
                <li><strong>Prediction Stage:</strong> The trained model then analyzes each test file in the test folder and predicts which maqam it belongs to, along with a confidence score.</li>
            </ol>
            <p><strong>Note:</strong> The first time you run the tests, the model will be trained. Subsequent runs will use the existing model unless you retrain it.</p>
        </div>
        
        <div class="section">
            <div class="section-title">Model Training & Testing</div>
            <button id="runTestsBtn">Run Tests (Train if needed & Test all files)</button>
            <button id="trainBtn">Train Model Only</button>
            <button id="predictAllBtn">Predict All Test Files</button>
            <div id="trainingStatus" class="training-status" style="display: none;"></div>
            <div id="output" style="display: none;"></div>
        </div>
        
        <div class="section">
            <div class="section-title">Test Files</div>
            <div id="fileList" class="file-list">
                {% for file in test_files %}
                <div class="file-item">
                    <div class="file-name">{{ file }}</div>
                    <button class="predict-btn" data-filename="{{ file }}">Predict Maqam</button>
                    <div id="result-{{ file }}" class="result" style="display: none;"></div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div id="allResults" class="section" style="display: none;">
            <div class="section-title">All Predictions</div>
            <table class="predictions-table">
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Predicted Maqam</th>
                        <th>Confidence</th>
                    </tr>
                </thead>
                <tbody id="allResultsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Run Tests functionality (trains if needed and tests all files)
        document.getElementById('runTestsBtn').addEventListener('click', async () => {
            const runTestsBtn = document.getElementById('runTestsBtn');
            const outputDiv = document.getElementById('output');
            
            runTestsBtn.disabled = true;
            outputDiv.style.display = 'block';
            outputDiv.textContent = 'Running tests...';
            
            try {
                const response = await fetch('/run_tests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    outputDiv.textContent = data.output;
                    if (data.error) {
                        outputDiv.innerHTML += '\n\n<span class="error">Warnings/Errors:\n' + data.error + '</span>';
                    }
                } else {
                    outputDiv.innerHTML = '<span class="error">Error: ' + data.error + '</span>';
                }
            } catch (error) {
                outputDiv.innerHTML = '<span class="error">Request failed: ' + error.message + '</span>';
            } finally {
                runTestsBtn.disabled = false;
            }
        });
        
        // Training functionality
        document.getElementById('trainBtn').addEventListener('click', async () => {
            const trainBtn = document.getElementById('trainBtn');
            const statusDiv = document.getElementById('trainingStatus');
            
            trainBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div>Starting training...</div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>';
            
            try {
                const response = await fetch('/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                statusDiv.innerHTML = `<div>${data.message}</div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>`;
                
                // Poll for training status
                pollTrainingStatus();
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                trainBtn.disabled = false;
            }
        });
        
        function pollTrainingStatus() {
            const statusDiv = document.getElementById('trainingStatus');
            const trainBtn = document.getElementById('trainBtn');
            let consecutiveErrors = 0;
            const maxConsecutiveErrors = 3;
            
            const interval = setInterval(async () => {
                try {
                    const response = await fetch('/training_status');
                    
                    if (!response.ok) {
                        // If response is not OK, get the text and display it
                        const text = await response.text();
                        statusDiv.innerHTML = `<div class="error">Error checking status: ${response.status} ${response.statusText}</div><pre>${text}</pre>`;
                        consecutiveErrors++;
                        
                        if (consecutiveErrors >= maxConsecutiveErrors) {
                            clearInterval(interval);
                            trainBtn.disabled = false;
                            statusDiv.innerHTML += '<div class="error">Too many consecutive errors. Stopping status checks.</div>';
                        }
                        return;
                    }
                    
                    // Reset error counter on successful response
                    consecutiveErrors = 0;
                    
                    const data = await response.json();
                    
                    // Update status display
                    let statusHtml = `<div>${data.status}</div>`;
                    
                    if (data.elapsed_time) {
                        statusHtml += `<div class="status-info"><span>Elapsed time: ${data.elapsed_time}</span><span>Progress: ${data.progress}%</span></div>`;
                    } else {
                        statusHtml += `<div>Progress: ${data.progress}%</div>`;
                    }
                    
                    statusHtml += `<div class="progress-bar"><div class="progress-fill" style="width: ${data.progress}%"></div></div>`;
                    
                    if (data.error) {
                        statusHtml += `<div class="error">Error: ${data.error}</div>`;
                    }
                    
                    statusDiv.innerHTML = statusHtml;
                    
                    if (!data.in_progress) {
                        clearInterval(interval);
                        trainBtn.disabled = false;
                    }
                } catch (error) {
                    statusDiv.innerHTML = `<div class="error">Error checking status: ${error.message}</div>`;
                    consecutiveErrors++;
                    
                    if (consecutiveErrors >= maxConsecutiveErrors) {
                        clearInterval(interval);
                        trainBtn.disabled = false;
                        statusDiv.innerHTML += '<div class="error">Too many consecutive errors. Stopping status checks.</div>';
                    }
                }
            }, 2000);
        }
        
        // Predict all files
        document.getElementById('predictAllBtn').addEventListener('click', async () => {
            const predictAllBtn = document.getElementById('predictAllBtn');
            const allResultsDiv = document.getElementById('allResults');
            const allResultsBody = document.getElementById('allResultsBody');
            
            predictAllBtn.disabled = true;
            allResultsDiv.style.display = 'block';
            allResultsBody.innerHTML = '<tr><td colspan="3">Processing all files...</td></tr>';
            
            try {
                const response = await fetch('/predict_all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.error) {
                    allResultsBody.innerHTML = `<tr><td colspan="3" class="error">${data.error}</td></tr>`;
                } else {
                    allResultsBody.innerHTML = '';
                    
                    data.results.forEach(result => {
                        const row = document.createElement('tr');
                        
                        if (result.error) {
                            row.innerHTML = `
                                <td>${result.file}</td>
                                <td colspan="2" class="error">${result.error}</td>
                            `;
                        } else {
                            row.innerHTML = `
                                <td>${result.file}</td>
                                <td>${result.prediction}</td>
                                <td>
                                    <div>${result.confidence}</div>
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: ${parseFloat(result.confidence) * 100}%"></div>
                                    </div>
                                </td>
                            `;
                        }
                        
                        allResultsBody.appendChild(row);
                    });
                }
            } catch (error) {
                allResultsBody.innerHTML = `<tr><td colspan="3" class="error">Request failed: ${error.message}</td></tr>`;
            } finally {
                predictAllBtn.disabled = false;
            }
        });
        
        // Individual file prediction
        document.querySelectorAll('.predict-btn').forEach(button => {
            button.addEventListener('click', async () => {
                const filename = button.getAttribute('data-filename');
                const resultDiv = document.getElementById(`result-${filename}`);
                
                button.disabled = true;
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = 'Processing...';
                
                try {
                    const response = await fetch(`/predict/${filename}`);
                    
                    if (!response.ok) {
                        const text = await response.text();
                        resultDiv.innerHTML = `<span class="error">Error: ${response.status} ${response.statusText}</span><pre>${text}</pre>`;
                        button.disabled = false;
                        return;
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        resultDiv.innerHTML = `<div class="error">${data.error}</div>`;
                    } else {
                        let topPredictionsHtml = '';
                        if (data.top_predictions && data.top_predictions.length > 0) {
                            topPredictionsHtml = '<div><strong>Top predictions:</strong><ul>';
                            data.top_predictions.forEach(pred => {
                                topPredictionsHtml += `<li>${pred.maqam}: ${pred.confidence}</li>`;
                            });
                            topPredictionsHtml += '</ul></div>';
                        }
                        
                        resultDiv.innerHTML = `
                            <div><strong>Predicted Maqam:</strong> ${data.prediction}</div>
                            <div><strong>Confidence:</strong> ${data.confidence}</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${parseFloat(data.confidence) * 100}%"></div>
                            </div>
                            ${topPredictionsHtml}
                        `;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error">Request failed: ${error.message}</div>`;
                } finally {
                    button.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
